<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MegaHAL-SQL: Pure SQL Chatbot in PostgreSQL in Your Browser</title>
  <style>
    :root {
      --bg:        #1a1b26;
      --surface:   #24283b;
      --border:    #292e42;
      --text:      #a9b1d6;
      --dim:       #565f89;
      --hal:       #c0caf5;
      --hal-label: #7aa2f7;
      --user-label:#e0af68;
      --status:    #e0af68;
      --sql-query: #7dcfff;
      --sql-result:#9ece6a;
      --sql-dim:   #565f89;
      --danger:    #f7768e;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      font-size: 15px;
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      max-width: 720px;
      width: 100%;
      margin: 0 auto;
      padding: 1.25rem 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    h1 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--hal);
      letter-spacing: 0.02em;
    }

    h1 .sql {
      color: var(--user-label);
      font-weight: 400;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--dim);
      margin-top: 0.15rem;
    }

    #status {
      color: var(--status);
      font-size: 0.75rem;
      padding: 0.35rem 0 0;
      min-height: 1.4em;
      opacity: 0.8;
    }

    #chat-log {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 0;
      min-height: 0;
    }

    .msg {
      padding: 0.2rem 0;
      word-wrap: break-word;
      line-height: 1.5;
    }

    .msg-hal .msg-label { color: var(--hal-label); font-weight: 600; }
    .msg-hal .msg-text  { color: var(--hal); }
    .msg-you .msg-label { color: var(--user-label); font-weight: 600; }
    .msg-you .msg-text  { color: var(--text); }
    .msg-sys { color: var(--dim); font-size: 0.8rem; }

    #input-row {
      display: flex;
      align-items: center;
      padding: 0.5rem 0;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      gap: 0.5rem;
    }

    #input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      padding: 0.4rem 0.6rem;
      outline: none;
      transition: border-color 0.15s;
    }

    #input:focus { border-color: var(--hal-label); }
    #input::placeholder { color: var(--dim); }
    #input:disabled { opacity: 0.35; }

    #reset-btn {
      background: transparent;
      color: var(--dim);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.75rem;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
    }

    #reset-btn:hover:not(:disabled) {
      color: var(--danger);
      border-color: var(--danger);
    }

    #reset-btn:disabled { opacity: 0.3; cursor: default; }

    #sql-panel {
      border-top: 1px solid var(--border);
      padding-top: 0.5rem;
      flex-shrink: 0;
    }

    #sql-toggle {
      background: var(--surface);
      color: var(--dim);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.7rem;
      padding: 0.2rem 0.6rem;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }

    #sql-toggle:hover {
      color: var(--text);
      border-color: var(--dim);
    }

    #sql-log {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 0.4rem;
      background: #16161e;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.4rem 0.6rem;
      font-family: "SF Mono", "Cascadia Code", "Fira Code", Consolas, "Courier New", monospace;
      font-size: 0.7rem;
    }

    #sql-log.hidden { display: none; }

    .sql-entry {
      padding: 0.25rem 0;
      border-bottom: 1px solid #1e1e2e;
    }

    .sql-entry:last-child { border-bottom: none; }

    .sql-query { color: var(--sql-query); }
    .sql-result {
      color: var(--sql-result);
      white-space: pre-wrap;
      font-size: 0.65rem;
      padding-left: 0.4rem;
      border-left: 2px solid var(--border);
      margin: 0.15rem 0 0.1rem 0;
    }

    .sql-separator {
      color: var(--dim);
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.4rem 0 0.15rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .sql-table-wrap {
      overflow-x: auto;
      margin: 0.15rem 0;
      font-size: 0.65rem;
    }

    .sql-table {
      border-collapse: collapse;
      color: var(--sql-result);
    }

    .sql-table th {
      color: var(--dim);
      border-bottom: 1px solid var(--border);
      text-align: left;
      padding: 0.15rem 0.8em 0.15rem 0;
      font-weight: 500;
      white-space: nowrap;
    }

    .sql-table td {
      padding: 0.1rem 0.8em 0.1rem 0;
      text-align: left;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .sql-table td:first-child { white-space: nowrap; }
    .sql-row-count { color: var(--sql-dim); font-size: 0.6rem; margin-top: 0.1rem; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--dim); }

    #footer {
      text-align: center;
      font-size: 0.7rem;
      color: var(--dim);
      padding-top: 0.4rem;
      flex-shrink: 0;
    }

    #footer a { color: var(--dim); text-decoration: none; }
    #footer a:hover { color: var(--text); }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>MegaHAL<span class="sql">-SQL</span></h1>
      <p class="subtitle">The classic chatbot running entirely in pure SQL, in PostgreSQL, in your browser</p>
      <div id="status">Starting PostgreSQL...</div>
    </header>

    <div id="chat-log"></div>

    <div id="input-row">
      <input id="input" type="text" disabled autocomplete="off" spellcheck="false"
             placeholder="Say something to MegaHAL...">
      <button id="reset-btn" disabled title="Erase brain and retrain from scratch">Reset</button>
    </div>

    <div id="sql-panel">
      <button id="sql-toggle">Show SQL</button>
      <div id="sql-log" class="hidden"></div>
    </div>

    <div id="footer">
      Powered by <a href="https://pglite.dev" target="_blank">PGlite</a>
      &middot; <a href="https://github.com/tgies/megahal-sql" target="_blank">Source</a>
    </div>
  </div>

<script type="module">
  import { PGliteWorker } from "https://cdn.jsdelivr.net/npm/@electric-sql/pglite@0.3.15/dist/worker/index.js";

  const statusEl  = document.getElementById("status");
  const chatLog   = document.getElementById("chat-log");
  const inputEl   = document.getElementById("input");
  const resetBtn  = document.getElementById("reset-btn");
  const sqlToggle = document.getElementById("sql-toggle");
  const sqlLog    = document.getElementById("sql-log");

  // During local dev (served from repo root, page at /web/index.html),
  // schema/ and data/ are one level up. When deployed to GitHub Pages
  // (index.html at root alongside schema/ and data/), they're siblings.
  const base = location.pathname.includes("/web/") ? ".." : ".";

  let pg;

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  function addMessage(who, text) {
    const div = document.createElement("div");
    div.className = `msg msg-${who}`;
    if (who === "sys") {
      div.textContent = text;
    } else {
      const labelSpan = document.createElement("span");
      labelSpan.className = "msg-label";
      labelSpan.textContent = who === "hal" ? "HAL " : "YOU ";
      const textSpan = document.createElement("span");
      textSpan.className = "msg-text";
      textSpan.textContent = text;
      div.appendChild(labelSpan);
      div.appendChild(textSpan);
    }
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function addSQLSeparator(label) {
    const div = document.createElement("div");
    div.className = "sql-separator";
    div.textContent = `── ${label} ──`;
    sqlLog.appendChild(div);
  }

  function logSQL(query, ms, result, params) {
    const entry = document.createElement("div");
    entry.className = "sql-entry";

    let queryStr = query;
    if (params && params.length) {
      const preview = String(params[0]);
      queryStr += `  -- $1 = '${preview.length > 40 ? preview.slice(0, 40) + "..." : preview}'`;
    }

    const qDiv = document.createElement("div");
    qDiv.className = "sql-query";
    qDiv.textContent = `${queryStr}  (${ms}ms)`;
    entry.appendChild(qDiv);

    if (result && result.rows && result.rows.length > 0) {
      const rDiv = document.createElement("div");
      rDiv.className = "sql-result";
      const cols = Object.keys(result.rows[0]);

      if (cols.length === 1 && cols[0] === "QUERY PLAN") {
        // EXPLAIN output -- show plan lines verbatim
        rDiv.textContent = result.rows.map(r => r["QUERY PLAN"]).join("\n");
        entry.appendChild(rDiv);
      } else if (result.rows.length === 1) {
        // Single row -- key: value pairs
        rDiv.textContent = "\u2192 " + cols.map(c => `${c}: ${result.rows[0][c]}`).join(", ");
        entry.appendChild(rDiv);
      } else {
        // Multi-row -- render as HTML table
        const wrap = document.createElement("div");
        wrap.className = "sql-table-wrap";
        const table = document.createElement("table");
        table.className = "sql-table";

        const thead = document.createElement("thead");
        const headTr = document.createElement("tr");
        for (const c of cols) {
          const th = document.createElement("th");
          th.textContent = c;
          headTr.appendChild(th);
        }
        thead.appendChild(headTr);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        const display = result.rows.slice(0, 15);
        for (const row of display) {
          const tr = document.createElement("tr");
          for (const c of cols) {
            const td = document.createElement("td");
            td.textContent = row[c] ?? "";
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        wrap.appendChild(table);

        const note = document.createElement("div");
        note.className = "sql-row-count";
        note.textContent = result.rows.length > 15
          ? `... (${result.rows.length} rows total)`
          : `(${result.rows.length} rows)`;
        wrap.appendChild(note);

        entry.appendChild(wrap);
      }
    }

    sqlLog.appendChild(entry);
    sqlLog.scrollTop = sqlLog.scrollHeight;
  }

  async function execSQL(sql, label) {
    const start = performance.now();
    const results = await pg.exec(sql);
    const ms = (performance.now() - start).toFixed(0);
    logSQL(label || sql.slice(0, 80) + (sql.length > 80 ? "..." : ""), ms, null);
    return results;
  }

  async function querySQL(sql, params, label) {
    const start = performance.now();
    const result = await pg.query(sql, params || []);
    const ms = (performance.now() - start).toFixed(0);
    logSQL(label || sql, ms, result, params);
    return result;
  }

  async function fetchText(path) {
    const resp = await fetch(path);
    if (!resp.ok) throw new Error(`Failed to fetch ${path}: ${resp.status}`);
    return resp.text();
  }

  async function isTrained() {
    try {
      const result = await pg.query(
        "SELECT EXISTS(SELECT 1 FROM trie_nodes WHERE parent_id IS NOT NULL) AS trained"
      );
      return result.rows[0].trained;
    } catch {
      return false;
    }
  }

  async function runDiagnostics() {
    addSQLSeparator("PostgreSQL Internals");

    await querySQL(
      `SELECT name, setting FROM pg_settings
       WHERE name IN ('server_version', 'work_mem', 'max_connections', 'search_path')
       ORDER BY name`,
      [], "pg_settings"
    );

    await querySQL(
      `SELECT p.proname AS function,
              pg_get_function_arguments(p.oid) AS arguments,
              pg_get_function_result(p.oid) AS returns,
              length(p.prosrc) AS source_chars
       FROM pg_proc p
       JOIN pg_namespace n ON n.oid = p.pronamespace
       WHERE n.nspname = 'public'
       ORDER BY p.proname`,
      [], "pg_proc (SQL functions in public schema)"
    );

    addSQLSeparator("Brain Statistics");

    await querySQL(
      `SELECT
         (SELECT count(*) FROM symbols) - 2 AS vocabulary,
         (SELECT count(*) FROM trie_nodes) - 2 AS trie_nodes,
         (SELECT count(*) FROM trie_nodes WHERE tree = 'F') - 1 AS forward_nodes,
         (SELECT count(*) FROM trie_nodes WHERE tree = 'B') - 1 AS backward_nodes`,
      [], "Markov trie statistics"
    );

    await querySQL(
      `SELECT c.relname AS table_name,
              c.reltuples::bigint AS estimated_rows,
              pg_size_pretty(pg_total_relation_size(c.oid)) AS total_size
       FROM pg_class c
       JOIN pg_namespace n ON n.oid = c.relnamespace
       WHERE n.nspname = 'public' AND c.relkind = 'r'
       ORDER BY pg_total_relation_size(c.oid) DESC`,
      [], "pg_class (table sizes from system catalog)"
    );

    await querySQL(
      `SELECT indexname, indexdef FROM pg_indexes WHERE schemaname = 'public'`,
      [], "pg_indexes"
    );

    addSQLSeparator("Query Planner Demo");

    await querySQL(
      `EXPLAIN (ANALYZE, COSTS, TIMING, FORMAT TEXT)
       SELECT s.word, tn.count, tn.usage
       FROM trie_nodes tn
       JOIN symbols s ON s.id = tn.symbol
       WHERE tn.parent_id = (
         SELECT id FROM trie_nodes WHERE parent_id IS NULL AND tree = 'F'
       )
       AND tn.tree = 'F'
       ORDER BY tn.count DESC
       LIMIT 5`,
      [], "EXPLAIN ANALYZE (trie join \u2192 shows Index Scan, Nested Loop, Sort...)"
    );

    await querySQL(
      `SELECT s.word, tn.count AS occurrences
       FROM trie_nodes tn
       JOIN symbols s ON s.id = tn.symbol
       WHERE tn.parent_id = (
         SELECT id FROM trie_nodes WHERE parent_id IS NULL AND tree = 'F'
       )
       AND tn.tree = 'F'
       ORDER BY tn.count DESC
       LIMIT 8`,
      [], "Top forward trie symbols (most frequent sentence starters)"
    );
  }

  async function init(force = false) {
    try {
      // Only create the worker on first boot -- reuse on reset
      if (!pg) {
        setStatus("Starting PostgreSQL (WASM)...");
        pg = new PGliteWorker(
          new Worker(new URL("./pglite-worker.js", import.meta.url), { type: "module" })
        );
      }

      setStatus("PostgreSQL ready, checking version...");
      const vResult = await querySQL("SELECT version()", [], "SELECT version()");
      const version = vResult.rows[0].version;
      addMessage("sys", version.split(",")[0] + " via PGlite WASM");

      // Check for existing trained brain in IndexedDB
      // (skip when force=true, i.e. user clicked Reset)
      setStatus("Checking for saved brain...");
      const trained = force ? false : await isTrained();

      if (trained) {
        addMessage("sys", "Loaded saved brain from IndexedDB.");
      } else {
        // Fresh database -- initialize everything
        setStatus("Initializing schema...");
        await execSQL(
          "DROP SCHEMA IF EXISTS public CASCADE; CREATE SCHEMA public;",
          "DROP/CREATE SCHEMA"
        );

        setStatus("Loading tables...");
        await execSQL(await fetchText(`${base}/schema/01-tables.sql`), "exec 01-tables.sql");

        setStatus("Loading seed data...");
        await execSQL(await fetchText(`${base}/schema/02-seed.sql`), "exec 02-seed.sql");

        setStatus("Loading functions (1125 lines of pure SQL)...");
        await execSQL(await fetchText(`${base}/schema/03-functions.sql`), "exec 03-functions.sql");

        setStatus("Loading support data (ban/aux/grt/swp)...");
        await execSQL(await fetchText("support-data.sql"), "exec support-data.sql");

        setStatus("Training brain with megahal.trn (this may take a moment)...");
        const trn = await fetchText(`${base}/data/megahal.trn`);
        const learnResult = await querySQL(
          "SELECT * FROM megahal_learn($1)",
          [trn],
          "megahal_learn(megahal.trn)"
        );
        const r = learnResult.rows[0];
        addMessage("sys",
          `Trained: ${r.lines_learned} lines, ${r.tokens_learned} tokens.`
        );
      }

      setStatus("Querying PostgreSQL system catalogs...");
      await runDiagnostics();

      sqlLog.classList.remove("hidden");
      sqlToggle.textContent = "Hide SQL";

      addSQLSeparator("Chat");
      setStatus("Generating greeting...");
      const greetResult = await querySQL("SELECT megahal_greet()", [], "megahal_greet()");
      addMessage("hal", greetResult.rows[0].megahal_greet);

      setStatus("Ready");
      inputEl.disabled = false;
      resetBtn.disabled = false;
      inputEl.focus();

    } catch (err) {
      setStatus(`Error: ${err.message}`);
      console.error("Init error:", err);
      addMessage("sys", `Initialization failed: ${err.message}`);
    }
  }

  async function chat(text) {
    const trimmed = text.trim();
    if (!trimmed) return;

    addMessage("you", trimmed);
    inputEl.value = "";
    inputEl.disabled = true;
    setStatus("Thinking...");

    try {
      const result = await querySQL(
        "SELECT megahal_converse($1)",
        [trimmed],
        "megahal_converse($1)"
      );
      addMessage("hal", result.rows[0].megahal_converse);

      await querySQL(
        `SELECT
           (SELECT count(*) FROM symbols) - 2 AS vocabulary,
           (SELECT count(*) FROM trie_nodes) - 2 AS trie_nodes`,
        [], "Brain state after learning"
      );
    } catch (err) {
      addMessage("sys", `Error: ${err.message}`);
      console.error("Chat error:", err);
    }

    setStatus("Ready");
    inputEl.disabled = false;
    inputEl.focus();
  }

  async function resetBrain() {
    if (!confirm("Reset brain? This erases all learned data and retrains from scratch.")) {
      return;
    }
    inputEl.disabled = true;
    resetBtn.disabled = true;
    chatLog.innerHTML = "";
    sqlLog.innerHTML = "";
    await init(true);
  }

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") chat(inputEl.value);
  });

  resetBtn.addEventListener("click", resetBrain);

  sqlToggle.addEventListener("click", () => {
    sqlLog.classList.toggle("hidden");
    sqlToggle.textContent = sqlLog.classList.contains("hidden") ? "Show SQL" : "Hide SQL";
  });

  init();
</script>
</body>
</html>
